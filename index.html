<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QA Jank & Frames Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #0a0e27;
        min-height: 100vh;
        color: #ffffff;
        overflow-x: hidden;
      }
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 20% 50%,
            rgba(120, 119, 198, 0.3) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 50%,
            rgba(255, 119, 198, 0.3) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 40% 80%,
            rgba(120, 219, 255, 0.2) 0%,
            transparent 50%
          );
        pointer-events: none;
        z-index: 1;
      }
      .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
        position: relative;
        z-index: 2;
      }
      .header {
        text-align: center;
        margin-bottom: 40px;
        animation: slideDown 0.8s ease-out;
      }
      @keyframes slideDown {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      h1 {
        font-size: 3.5em;
        font-weight: 900;
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #f093fb 50%,
          #f5576c 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 2px;
      }
      .subtitle {
        color: rgba(255, 255, 255, 0.7);
        font-size: 1.2em;
        font-weight: 300;
      }

      /* KPI Cards */
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
        animation: fadeIn 1s ease-out 0.3s both;
      }
      .kpi-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 20px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
      }
      .kpi-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #667eea, #f093fb);
        animation: shimmer 3s infinite;
      }
      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }
      .kpi-card:hover {
        transform: translateY(-5px);
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.2);
      }
      .kpi-title {
        font-size: 0.85em;
        color: rgba(255, 255, 255, 0.6);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
      }
      .kpi-value {
        font-size: 2em;
        font-weight: 700;
        color: #fff;
      }
      .kpi-status {
        margin-top: 6px;
        font-weight: 600;
      }
      .good {
        color: #34d399;
      }
      .warn {
        color: #fbbf24;
      }
      .bad {
        color: #f87171;
      }

      /* Upload section */
      .file-upload-section {
        background: rgba(255, 255, 255, 0.03);
        border: 2px dashed rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 40px;
        text-align: center;
        transition: all 0.3s ease;
        animation: fadeIn 1s ease-out 0.5s both;
      }
      .file-buttons {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-top: 20px;
      }
      .file-input-label {
        padding: 15px 30px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-radius: 15px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
      }
      input[type="file"] {
        display: none;
      }

      /* Charts */
      .chart-container {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 25px;
        position: relative;
        animation: scaleIn 0.8s ease-out;
        margin-bottom: 40px;
      }
      @keyframes scaleIn {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .chart-title {
        font-size: 1.3em;
        font-weight: 600;
        color: #fff;
      }
      .chart-badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        background: rgba(147, 51, 234, 0.2);
        color: #c084fc;
        border: 1px solid #c084fc;
      }
      .chart-wrapper {
        position: relative;
        height: 450px;
        width: 100%;
      }

      .export-button {
        position: fixed;
        bottom: 30px;
        right: 30px;
        padding: 15px 30px;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: none;
        border-radius: 50px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
        transition: all 0.3s ease;
        z-index: 1000;
      }
      .export-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
      }
      .export-button:disabled {
        background: #555;
        cursor: not-allowed;
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>QA JANK & FRAMES</h1>
        <p class="subtitle">Frame Stability Analysis</p>
      </div>

      <!-- Upload -->
      <div class="file-upload-section">
        <h3>üìä Load Jank Data</h3>
        <p
          style="
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 20px;
            margin-top: 10px;
          "
        >
          Upload the unified TSV file to analyze
        </p>
        <div class="file-buttons">
          <label for="dataFile" class="file-input-label"
            >üìÇ Load Data TSV</label
          >
          <input type="file" id="dataFile" accept=".tsv,.csv,.txt" />
        </div>
        <div
          id="fileStatus"
          style="margin-top: 10px; color: rgba(255, 255, 255, 0.6)"
        ></div>
      </div>

      <!-- KPI Cards -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-title">üìâ Jank % (Superbet App)</div>
          <div id="kpiJank" class="kpi-value">‚Äì</div>
          <div id="kpiJankStatus" class="kpi-status">‚Äì</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-title">üñºÔ∏è Dropped Frames % (Superbet App)</div>
          <div id="kpiDropped" class="kpi-value">‚Äì</div>
          <div id="kpiDroppedStatus" class="kpi-status">‚Äì</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-title">‚ö° Top Jank Type</div>
          <div id="kpiTopType" class="kpi-value" style="font-size: 1.2em">
            ‚Äì
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">Summary by Layer</h3>
          <span class="chart-badge">SUMMARY</span>
        </div>
        <div class="chart-wrapper"><canvas id="summaryChart"></canvas></div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">Jank % Timeline</h3>
          <span class="chart-badge">TIMELINE</span>
        </div>
        <div class="chart-wrapper"><canvas id="timelineChart"></canvas></div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">Jank Types</h3>
          <span class="chart-badge">TYPES</span>
        </div>
        <div class="chart-wrapper"><canvas id="typesChart"></canvas></div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">Dropped Frames</h3>
          <span class="chart-badge">DROPS</span>
        </div>
        <div class="chart-wrapper"><canvas id="droppedChart"></canvas></div>
      </div>
    </div>

    <button id="exportPdfBtn" class="export-button" disabled>
      üìÑ Export to PDF
    </button>

    <script>
      let charts = {};

      document
        .getElementById("dataFile")
        .addEventListener("change", (e) => loadUnifiedFile(e));

      let summaryData = []; // store summary globally so we can reuse

      function loadFile(e, type) {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById(
          "fileStatus"
        ).textContent = `Loading ${file.name}...`;
        Papa.parse(file, {
          complete: (results) => {
            if (type === "summary") {
              summaryData = results.data; // save for later
              drawSummaryChart(results.data);
              updateJankKPI(results.data);
            }
            if (type === "timeline") drawTimelineChart(results.data);
            if (type === "types") {
              drawTypesChart(results.data);
              updateTopTypeKPI(results.data);
            }
            if (type === "dropped") {
              drawDroppedChart(results.data);
              updateDroppedKPI(results.data);
            }
            enableExportButton();
            document.getElementById(
              "fileStatus"
            ).textContent = `‚úì Loaded ${file.name}`;
          },
          header: true,
          delimiter: "\t",
          skipEmptyLines: true,
          dynamicTyping: true,
        });
      }

      function loadUnifiedFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById(
          "fileStatus"
        ).textContent = `Loading ${file.name}...`;

        Papa.parse(file, {
          complete: (results) => {
            const rows = results.data;

            // split rows by data_type
            const summary = rows.filter((r) => r.data_type === "summary");
            const timeline = rows.filter((r) => r.data_type === "timeline");
            const types = rows.filter((r) => r.data_type === "jank_types");
            const dropped = rows.filter((r) => r.data_type === "dropped");

            summaryData = summary; // store globally for KPIs
            drawSummaryChart(summary);
            updateJankKPI(summary);

            drawTimelineChart(timeline);
            drawTypesChart(types);
            updateTopTypeKPI(types);

            drawDroppedChart(dropped);
            updateDroppedKPI(dropped);

            enableExportButton();
            document.getElementById(
              "fileStatus"
            ).textContent = `‚úì Loaded ${file.name}`;
          },
          header: true,
          delimiter: "\t",
          skipEmptyLines: true,
          dynamicTyping: true,
        });
      }

      // KPI updaters
      function updateJankKPI(data) {
        const app = data.find(
          (r) => (r.simplified_layer || r.layer_name) === "Superbet App"
        );
        if (!app) return;
        const jank = app.jank_percent || 0;
        document.getElementById("kpiJank").textContent = jank.toFixed(2) + "%";
        let status = "good",
          text = "‚úÖ Good";
        if (jank > 10 && jank <= 20) {
          status = "warn";
          text = "‚ö†Ô∏è Needs Attention";
        } else if (jank > 20) {
          status = "bad";
          text = "‚ùå Poor";
        }
        document.getElementById("kpiJankStatus").textContent = text;
        document.getElementById("kpiJankStatus").className =
          "kpi-status " + status;
      }

      function updateDroppedKPI(droppedData) {
        if (!summaryData.length) return;

        // get total frames from summary
        const appSummary = summaryData.find(
          (r) => (r.simplified_layer || r.layer_name) === "Superbet App"
        );
        if (!appSummary) return;
        const totalFrames = appSummary.total_frames || 0;

        // sum dropped frames from droppedData
        const appDropped = droppedData.filter(
          (r) => (r.simplified_layer || r.layer_name) === "Superbet App"
        );
        const droppedFrames = appDropped.reduce(
          (sum, r) => sum + (r.dropped_frames || 0),
          0
        );

        const percent =
          totalFrames > 0 ? (droppedFrames * 100) / totalFrames : 0;

        document.getElementById("kpiDropped").textContent =
          percent.toFixed(2) + "%";

        let status = "good",
          text = "‚úÖ Good";
        if (percent > 5 && percent <= 10) {
          status = "warn";
          text = "‚ö†Ô∏è Needs Attention";
        } else if (percent > 10) {
          status = "bad";
          text = "‚ùå Poor";
        }
        document.getElementById("kpiDroppedStatus").textContent = text;
        document.getElementById("kpiDroppedStatus").className =
          "kpi-status " + status;
      }

      function updateTopTypeKPI(data) {
        if (!data.length) return;

        // FIX: use dropped_frames (where the count is stored from SQL UNION)
        const sorted = [...data].sort(
          (a, b) => (b.dropped_frames || 0) - (a.dropped_frames || 0)
        );

        document.getElementById("kpiTopType").textContent =
          sorted[0].jank_type || "Unknown";
      }

      // Charts
      function drawSummaryChart(data) {
        const labels = data.map((r) => r.simplified_layer || r.layer_name);
        const values = data.map((r) => r.jank_percent);
        if (charts.summary) charts.summary.destroy();
        charts.summary = new Chart(document.getElementById("summaryChart"), {
          type: "doughnut",
          data: {
            labels,
            datasets: [
              {
                data: values,
                backgroundColor: ["#f87171", "#60a5fa", "#34d399"],
              },
            ],
          },
          options: { responsive: true },
        });
      }
      function drawTimelineChart(data) {
        const grouped = {};
        data.forEach((r) => {
          const layer = r.simplified_layer || r.layer_name;
          if (!grouped[layer]) grouped[layer] = [];
          grouped[layer].push({ x: r.second_bucket, y: r.jank_percent });
        });
        const datasets = Object.keys(grouped).map((layer, i) => ({
          label: layer,
          data: grouped[layer],
          borderColor: ["#f87171", "#60a5fa", "#34d399", "#fbbf24"][i % 4],
          fill: false,
          tension: 0.1,
        }));
        if (charts.timeline) charts.timeline.destroy();
        charts.timeline = new Chart(document.getElementById("timelineChart"), {
          type: "line",
          data: { datasets },
          options: {
            scales: {
              x: { type: "linear", title: { text: "Time (s)", display: true } },
              y: { title: { text: "Jank %", display: true } },
            },
          },
        });
      }
      function drawTypesChart(data) {
        const labels = data.map((r) => r.jank_type || "Unknown");
        // FIX: use dropped_frames, since that's where the count ends up in the UNION
        const values = data.map((r) => r.dropped_frames || 0);

        if (charts.types) charts.types.destroy();
        charts.types = new Chart(document.getElementById("typesChart"), {
          type: "bar",
          data: {
            labels,
            datasets: [
              { label: "Count", data: values, backgroundColor: "#60a5fa" },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: {
                ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 },
              },
              y: { beginAtZero: true },
            },
          },
        });
      }

      function drawDroppedChart(data) {
        const grouped = {};
        data.forEach((r) => {
          const layer = r.simplified_layer || r.layer_name;
          if (!grouped[layer]) grouped[layer] = [];
          grouped[layer].push({ x: r.second_bucket, y: r.dropped_frames || 0 });
        });
        const datasets = Object.keys(grouped).map((layer, i) => ({
          label: layer,
          data: grouped[layer],
          borderColor: ["#f87171", "#60a5fa", "#34d399", "#fbbf24"][i % 4],
          fill: false,
          tension: 0.1,
        }));
        if (charts.dropped) charts.dropped.destroy();
        charts.dropped = new Chart(document.getElementById("droppedChart"), {
          type: "line",
          data: { datasets },
          options: {
            scales: {
              x: { type: "linear", title: { text: "Time (s)", display: true } },
              y: { title: { text: "Dropped Frames", display: true } },
            },
          },
        });
      }

      function enableExportButton() {
        const btn = document.getElementById("exportPdfBtn");

        // Enable if at least one data/chart is present
        if (
          summaryData.length > 0 ||
          charts.timeline ||
          charts.types ||
          charts.dropped
        ) {
          btn.disabled = false;
        }
      }

      async function exportToPDF() {
        const btn = document.getElementById("exportPdfBtn");
        btn.disabled = true;
        btn.textContent = "‚è≥ Generating PDF...";

        try {
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF("p", "mm", "a4");
          let yPos = 20;

          pdf.setFontSize(20);
          pdf.setTextColor(102, 126, 234);
          pdf.text("QA Jank & Frames Report", 105, yPos, { align: "center" });
          yPos += 15;

          // KPIs
          pdf.setFontSize(12);
          pdf.setTextColor(0, 0, 0);
          pdf.text(
            `Jank %: ${document.getElementById("kpiJank").textContent}`,
            15,
            yPos
          );
          yPos += 7;
          pdf.text(
            `Dropped Frames %: ${
              document.getElementById("kpiDropped").textContent
            }`,
            15,
            yPos
          );
          yPos += 7;
          pdf.text(
            `Top Jank Type: ${
              document.getElementById("kpiTopType").textContent
            }`,
            15,
            yPos
          );
          yPos += 12;

          // Charts
          await addChartToPDF(pdf, "summaryChart", "Summary by Layer", yPos);
          pdf.addPage();
          await addChartToPDF(pdf, "timelineChart", "Jank % Timeline", 20);
          pdf.addPage();
          await addChartToPDF(pdf, "typesChart", "Jank Types", 20);
          pdf.addPage();
          await addChartToPDF(pdf, "droppedChart", "Dropped Frames", 20);

          // Save file
          const timestamp = new Date()
            .toISOString()
            .slice(0, 19)
            .replace(/:/g, "-");
          pdf.save(`QA-Jank-Frames-Report-${timestamp}.pdf`);

          btn.textContent = "‚úì PDF Exported!";
          setTimeout(() => {
            btn.textContent = "üìÑ Export to PDF";
            btn.disabled = false;
          }, 2000);
        } catch (err) {
          console.error("PDF generation error:", err);
          btn.textContent = "‚ùå Export Failed";
          setTimeout(() => {
            btn.textContent = "üìÑ Export to PDF";
            btn.disabled = false;
          }, 2000);
        }
      }

      async function addChartToPDF(pdf, chartId, title, startY) {
        pdf.setFontSize(14);
        pdf.setTextColor(0, 0, 0);
        pdf.text(title, 105, startY, { align: "center" });

        const chartEl = document.getElementById(chartId);
        if (!chartEl) return;
        const imgData = chartEl.toDataURL("image/png");
        pdf.addImage(imgData, "PNG", 15, startY + 10, 180, 100);
      }

      // Listener
      document
        .getElementById("exportPdfBtn")
        .addEventListener("click", exportToPDF);
    </script>
  </body>
</html>
